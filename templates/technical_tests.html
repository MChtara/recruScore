{% extends "base.html" %}

{% block title %}Tests Techniques - JobMatch Pro{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <h2 class="mb-4 text-center">
            <i class="fas fa-laptop-code me-2 text-info"></i>
            Tests Techniques
        </h2>

        <!-- Intro -->
        <div class="alert alert-info mb-4">
            <h5><i class="fas fa-info-circle me-2"></i>Comment ça marche ?</h5>
            <ol class="mb-0">
                <li>Nous avons extrait les compétences techniques déclarées dans votre CV</li>
                <li>Pour chaque compétence, cliquez sur "Générer le test" pour obtenir un test adapté</li>
                <li>Les tests sont générés automatiquement selon votre niveau et le type de compétence</li>
                <li>Passez les tests pour valider vos compétences</li>
            </ol>
        </div>

        <!-- Résumé -->
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-user-circle me-2"></i>
                    Profil Technique
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>CV :</strong> {{ cv_filename }}</p>
                        <p><strong>Niveau global :</strong> <span class="badge bg-info">{{ competences.niveau_global|upper }}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Résumé :</strong> {{ competences.resume_competences }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Langages de Programmation -->
        {% if competences.langages_programmation and competences.langages_programmation|length > 0 %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-code me-2"></i>
                    Langages de Programmation ({{ competences.langages_programmation|length }})
                </h5>
            </div>
            <div class="card-body">
                {% for langage in competences.langages_programmation %}
                <div class="skill-item mb-2 border rounded" id="skill_langages_programmation_{{ loop.index0 }}">
                    <div class="p-3" style="cursor: pointer;" onclick="toggleSkillDetails('langages_programmation', {{ loop.index0 }})">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <i class="fas fa-chevron-right" id="arrow_langages_programmation_{{ loop.index0 }}" style="transition: transform 0.3s;"></i>
                            </div>
                            <div class="col">
                                <h6 class="mb-0 d-inline">
                                    {{ langage.nom }}
                                    <span id="niveau_badge_langages_programmation_{{ loop.index0 }}">
                                        {% if langage.niveau_teste %}
                                        <span class="badge bg-success ms-2">{{ langage.niveau|upper }}</span>
                                        {% if langage.difficulte_testee %}
                                        <span class="badge bg-info ms-1" style="font-size: 0.7em;">{{ langage.difficulte_testee }}</span>
                                        {% endif %}
                                        {% endif %}
                                    </span>
                                </h6>
                                {% if langage.experience and langage.experience.lower() != 'non spécifié' %}
                                <small class="text-muted ms-2"><i class="fas fa-clock me-1"></i>{{ langage.experience }}</small>
                                {% endif %}
                            </div>
                            <div class="col-auto">
                                <div id="status_langages_programmation_{{ loop.index0 }}">
                                    {% if langage.niveau_teste %}
                                    <small class="text-success"><i class="fas fa-check-circle me-1"></i>{{ langage.score_test }}%</small>
                                    {% else %}
                                    <small class="text-muted"><i class="fas fa-question-circle me-1"></i>Non testé</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); showDifficultySelector('langages_programmation', {{ loop.index0 }})">
                                    <i class="fas fa-flask me-1"></i>Tester
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Sélecteur de difficulté (caché par défaut) -->
                    <div class="difficulty-selector border-top p-3" id="difficulty_langages_programmation_{{ loop.index0 }}" style="display:none;">
                        <h6 class="mb-3"><i class="fas fa-sliders-h me-2"></i>Choisissez le niveau de difficulté :</h6>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-success" onclick="generateTestWithDifficulty('langages_programmation', {{ loop.index0 }}, 'facile')">
                                <i class="fas fa-smile me-1"></i>Facile
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="generateTestWithDifficulty('langages_programmation', {{ loop.index0 }}, 'moyen')">
                                <i class="fas fa-meh me-1"></i>Moyen
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="generateTestWithDifficulty('langages_programmation', {{ loop.index0 }}, 'difficile')">
                                <i class="fas fa-fire me-1"></i>Difficile
                            </button>
                        </div>
                    </div>
                    <div class="test-container border-top p-3" id="test_langages_programmation_{{ loop.index0 }}" style="display:none;"></div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Bases de Données -->
        {% if competences.bases_donnees and competences.bases_donnees|length > 0 %}
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-database me-2"></i>
                    Bases de Données ({{ competences.bases_donnees|length }})
                </h5>
            </div>
            <div class="card-body">
                {% for db in competences.bases_donnees %}
                <div class="skill-item mb-2 border rounded" id="skill_bases_donnees_{{ loop.index0 }}">
                    <div class="p-3" style="cursor: pointer;" onclick="toggleSkillDetails('bases_donnees', {{ loop.index0 }})">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <i class="fas fa-chevron-right" id="arrow_bases_donnees_{{ loop.index0 }}" style="transition: transform 0.3s;"></i>
                            </div>
                            <div class="col">
                                <h6 class="mb-0 d-inline">
                                    {{ db.nom }}
                                    <span id="niveau_badge_bases_donnees_{{ loop.index0 }}">
                                        {% if db.niveau_teste %}
                                        <span class="badge bg-success ms-2">{{ db.niveau|upper }}</span>
                                        {% if db.difficulte_testee %}
                                        <span class="badge bg-info ms-1" style="font-size: 0.7em;">{{ db.difficulte_testee }}</span>
                                        {% endif %}
                                        {% endif %}
                                    </span>
                                </h6>
                                <small class="text-muted ms-2"><i class="fas fa-tag me-1"></i>{{ db.type }}</small>
                            </div>
                            <div class="col-auto">
                                <div id="status_bases_donnees_{{ loop.index0 }}">
                                    {% if db.niveau_teste %}
                                    <small class="text-success"><i class="fas fa-check-circle me-1"></i>{{ db.score_test }}%</small>
                                    {% else %}
                                    <small class="text-muted"><i class="fas fa-question-circle me-1"></i>Non testé</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); showDifficultySelector('bases_donnees', {{ loop.index0 }})">
                                    <i class="fas fa-flask me-1"></i>Tester
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Sélecteur de difficulté -->
                    <div class="difficulty-selector border-top p-3" id="difficulty_bases_donnees_{{ loop.index0 }}" style="display:none;">
                        <h6 class="mb-3"><i class="fas fa-sliders-h me-2"></i>Choisissez le niveau de difficulté :</h6>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-success" onclick="generateTestWithDifficulty('bases_donnees', {{ loop.index0 }}, 'facile')">
                                <i class="fas fa-smile me-1"></i>Facile
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="generateTestWithDifficulty('bases_donnees', {{ loop.index0 }}, 'moyen')">
                                <i class="fas fa-meh me-1"></i>Moyen
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="generateTestWithDifficulty('bases_donnees', {{ loop.index0 }}, 'difficile')">
                                <i class="fas fa-fire me-1"></i>Difficile
                            </button>
                        </div>
                    </div>
                    <div class="test-container border-top p-3" id="test_bases_donnees_{{ loop.index0 }}" style="display:none;"></div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Frameworks & Bibliothèques -->
        {% if competences.frameworks_bibliotheques and competences.frameworks_bibliotheques|length > 0 %}
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-layer-group me-2"></i>
                    Frameworks & Bibliothèques ({{ competences.frameworks_bibliotheques|length }})
                </h5>
            </div>
            <div class="card-body">
                {% for framework in competences.frameworks_bibliotheques %}
                <div class="skill-item mb-2 border rounded" id="skill_frameworks_bibliotheques_{{ loop.index0 }}">
                    <div class="p-3" style="cursor: pointer;" onclick="toggleSkillDetails('frameworks_bibliotheques', {{ loop.index0 }})">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <i class="fas fa-chevron-right" id="arrow_frameworks_bibliotheques_{{ loop.index0 }}" style="transition: transform 0.3s;"></i>
                            </div>
                            <div class="col">
                                <h6 class="mb-0 d-inline">
                                    {{ framework.nom }}
                                    <span id="niveau_badge_frameworks_bibliotheques_{{ loop.index0 }}">
                                        {% if framework.niveau_teste %}
                                        <span class="badge bg-success ms-2">{{ framework.niveau|upper }}</span>
                                        {% if framework.difficulte_testee %}
                                        <span class="badge bg-info ms-1" style="font-size: 0.7em;">{{ framework.difficulte_testee }}</span>
                                        {% endif %}
                                        {% endif %}
                                    </span>
                                </h6>
                                <small class="text-muted ms-2"><i class="fas fa-tag me-1"></i>{{ framework.categorie }}</small>
                            </div>
                            <div class="col-auto">
                                <div id="status_frameworks_bibliotheques_{{ loop.index0 }}">
                                    {% if framework.niveau_teste %}
                                    <small class="text-success"><i class="fas fa-check-circle me-1"></i>{{ framework.score_test }}%</small>
                                    {% else %}
                                    <small class="text-muted"><i class="fas fa-question-circle me-1"></i>Non testé</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); showDifficultySelector('frameworks_bibliotheques', {{ loop.index0 }})">
                                    <i class="fas fa-flask me-1"></i>Tester
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="difficulty-selector border-top p-3" id="difficulty_frameworks_bibliotheques_{{ loop.index0 }}" style="display:none;">
                        <h6 class="mb-3"><i class="fas fa-sliders-h me-2"></i>Choisissez le niveau de difficulté :</h6>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-success" onclick="generateTestWithDifficulty('frameworks_bibliotheques', {{ loop.index0 }}, 'facile')">
                                <i class="fas fa-smile me-1"></i>Facile
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="generateTestWithDifficulty('frameworks_bibliotheques', {{ loop.index0 }}, 'moyen')">
                                <i class="fas fa-meh me-1"></i>Moyen
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="generateTestWithDifficulty('frameworks_bibliotheques', {{ loop.index0 }}, 'difficile')">
                                <i class="fas fa-fire me-1"></i>Difficile
                            </button>
                        </div>
                    </div>
                    <div class="test-container border-top p-3" id="test_frameworks_bibliotheques_{{ loop.index0 }}" style="display:none;"></div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Domaines d'Expertise -->
        {% if competences.domaines_expertise and competences.domaines_expertise|length > 0 %}
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Domaines d'Expertise ({{ competences.domaines_expertise|length }})
                </h5>
            </div>
            <div class="card-body">
                {% for domaine in competences.domaines_expertise %}
                <div class="skill-item mb-2 border rounded" id="skill_domaines_expertise_{{ loop.index0 }}">
                    <div class="p-3" style="cursor: pointer;" onclick="toggleSkillDetails('domaines_expertise', {{ loop.index0 }})">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <i class="fas fa-chevron-right" id="arrow_domaines_expertise_{{ loop.index0 }}" style="transition: transform 0.3s;"></i>
                            </div>
                            <div class="col">
                                <h6 class="mb-0 d-inline">
                                    {{ domaine.nom }}
                                    <span id="niveau_badge_domaines_expertise_{{ loop.index0 }}">
                                        {% if domaine.niveau_teste %}
                                        <span class="badge bg-success ms-2">{{ domaine.niveau|upper }}</span>
                                        {% if domaine.difficulte_testee %}
                                        <span class="badge bg-info ms-1" style="font-size: 0.7em;">{{ domaine.difficulte_testee }}</span>
                                        {% endif %}
                                        {% endif %}
                                    </span>
                                </h6>
                                <small class="text-muted ms-2"><i class="fas fa-tools me-1"></i>{{ domaine.competences_associees|join(', ') }}</small>
                            </div>
                            <div class="col-auto">
                                <div id="status_domaines_expertise_{{ loop.index0 }}">
                                    {% if domaine.niveau_teste %}
                                    <small class="text-success"><i class="fas fa-check-circle me-1"></i>{{ domaine.score_test }}%</small>
                                    {% else %}
                                    <small class="text-muted"><i class="fas fa-question-circle me-1"></i>Non testé</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showDifficultySelector('domaines_expertise', {{ loop.index0 }})">
                                    <i class="fas fa-flask me-1"></i>Tester
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="difficulty-selector border-top p-3" id="difficulty_domaines_expertise_{{ loop.index0 }}" style="display:none;">
                        <h6 class="mb-3"><i class="fas fa-sliders-h me-2"></i>Choisissez le niveau de difficulté :</h6>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-success" onclick="generateTestWithDifficulty('domaines_expertise', {{ loop.index0 }}, 'facile')">
                                <i class="fas fa-smile me-1"></i>Facile
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="generateTestWithDifficulty('domaines_expertise', {{ loop.index0 }}, 'moyen')">
                                <i class="fas fa-meh me-1"></i>Moyen
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="generateTestWithDifficulty('domaines_expertise', {{ loop.index0 }}, 'difficile')">
                                <i class="fas fa-fire me-1"></i>Difficile
                            </button>
                        </div>
                    </div>
                    <div class="test-container border-top p-3" id="test_domaines_expertise_{{ loop.index0 }}" style="display:none;"></div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="text-center mt-4">
            <a href="{{ url_for('my_cv') }}" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-arrow-left me-2"></i>
                Retour à Mon CV
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-home me-2"></i>
                Retour à la recherche
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Fonction pour replier/déplier une compétence
    function toggleSkillDetails(category, skillIndex) {
        const testContainer = document.getElementById(`test_${category}_${skillIndex}`);
        const arrow = document.getElementById(`arrow_${category}_${skillIndex}`);

        if (testContainer.style.display === 'none' || testContainer.style.display === '') {
            testContainer.style.display = 'block';
            arrow.style.transform = 'rotate(90deg)';
        } else {
            testContainer.style.display = 'none';
            arrow.style.transform = 'rotate(0deg)';
        }
    }

    // Afficher le sélecteur de difficulté
    function showDifficultySelector(category, skillIndex) {
        const difficultySelector = document.getElementById(`difficulty_${category}_${skillIndex}`);
        const arrow = document.getElementById(`arrow_${category}_${skillIndex}`);

        // Ouvrir la section
        difficultySelector.style.display = 'block';
        if (arrow) arrow.style.transform = 'rotate(90deg)';
    }

    // Générer le test avec le niveau de difficulté choisi
    function generateTestWithDifficulty(category, skillIndex, difficulte) {
        const difficultySelector = document.getElementById(`difficulty_${category}_${skillIndex}`);
        const testContainer = document.getElementById(`test_${category}_${skillIndex}`);
        const arrow = document.getElementById(`arrow_${category}_${skillIndex}`);

        // Masquer le sélecteur
        difficultySelector.style.display = 'none';

        // Ouvrir le conteneur de test
        testContainer.style.display = 'block';
        if (arrow) arrow.style.transform = 'rotate(90deg)';

        // Afficher le chargement
        testContainer.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
                <p class="text-muted">Génération du test en cours (difficulté: ${difficulte})...</p>
            </div>
        `;

        fetch(`/generate-test/${category}/${skillIndex}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ difficulte: difficulte })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTest(testContainer, data.test, category, skillIndex);
            } else {
                throw new Error(data.error || 'Erreur lors de la génération');
            }
        })
        .catch(error => {
            testContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Erreur:</strong> ${error.message}
                </div>
            `;
        });
    }

    function generateTest(category, skillIndex) {
        const testContainer = document.getElementById(`test_${category}_${skillIndex}`);
        const arrow = document.getElementById(`arrow_${category}_${skillIndex}`);
        const button = event.target.closest('button');

        // Ouvrir la section automatiquement
        testContainer.style.display = 'block';
        if (arrow) arrow.style.transform = 'rotate(90deg)';

        // Afficher "Génération en cours"
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Génération...';
        button.disabled = true;

        fetch(`/generate-test/${category}/${skillIndex}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTest(testContainer, data.test, category, skillIndex);
                button.innerHTML = '<i class="fas fa-check me-1"></i>Test généré';
                button.classList.remove('btn-primary', 'btn-success', 'btn-warning', 'btn-secondary');
                button.classList.add('btn-info');
            } else {
                throw new Error(data.error || 'Erreur lors de la génération');
            }
        })
        .catch(error => {
            let errorMsg = error.message;

            if (errorMsg.includes('Limite API') || errorMsg.includes('429')) {
                testContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-hourglass-half me-2"></i>
                        <strong>Limite API atteinte</strong><br>
                        L'API Groq a atteint sa limite de requêtes. Veuillez patienter 30 secondes avant de réessayer.
                    </div>
                `;
                testContainer.style.display = 'block';

                button.innerHTML = '<i class="fas fa-redo me-1"></i>Réessayer dans 30s';

                // Compte à rebours
                let countdown = 30;
                const countdownInterval = setInterval(() => {
                    countdown--;
                    button.innerHTML = `<i class="fas fa-redo me-1"></i>Réessayer dans ${countdown}s`;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        button.innerHTML = '<i class="fas fa-plus-circle me-1"></i>Générer le test';
                        button.disabled = false;
                    }
                }, 1000);
            } else {
                testContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Erreur:</strong> ${errorMsg}
                    </div>
                `;
                testContainer.style.display = 'block';

                button.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Erreur';
                setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-plus-circle me-1"></i>Générer le test';
                    button.disabled = false;
                }, 2000);
            }
        });
    }

    function displayTest(container, test, category, skillIndex) {
        let html = `
            <div class="card border-info">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>${test.competence_testee}
                        <span class="badge bg-info ms-2">${test.type_test}</span>
                        <span class="badge bg-secondary ms-1">${test.niveau_difficulte}</span>
                        <span class="badge bg-warning text-dark ms-1">${test.duree_estimee} min</span>
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-3"><strong>Énoncé:</strong> ${test.enonce}</p>
        `;

        // Afficher info
        html += `
            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Test QCM indépendant</strong> - ${test.questions ? test.questions.length : 0} questions. Score de réussite: 60%
            </div>
        `;

        // Questions QCM uniquement
        if (test.questions && test.questions.length > 0) {
            test.questions.forEach((question, i) => {
                html += `
                    <div class="mb-4 p-3 bg-light rounded">
                        <p class="mb-2"><strong>Question ${i+1}:</strong> ${question.question || 'Question non définie'}</p>
                `;

                if (question.options && question.options.length > 0) {
                    question.options.forEach((option, j) => {
                        html += `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="q_${i}" id="q${category}_${skillIndex}_${i}_opt${j}" value="${j}">
                                <label class="form-check-label" for="q${category}_${skillIndex}_${i}_opt${j}">
                                    ${option}
                                </label>
                            </div>
                        `;
                    });
                } else {
                    html += '<p class="text-danger">Aucune option disponible</p>';
                }

                html += '</div>';
            });
        } else {
            html += '<div class="alert alert-warning">Aucune question générée</div>';
        }

        // Bouton soumettre
        html += `
                    <button class="btn btn-success" onclick="submitTest('${category}', ${skillIndex})">
                        <i class="fas fa-check-circle me-2"></i>Soumettre les réponses
                    </button>
                </div>
            </div>
            <div class="result-container mt-3" id="result_${category}_${skillIndex}" style="display:none;"></div>
        `;

        container.innerHTML = html;
        container.style.display = 'block';
    }

    function submitTest(category, skillIndex) {
        const button = event.target;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Évaluation...';
        button.disabled = true;

        // Collecter les réponses depuis le conteneur du test spécifique
        const testContainer = document.getElementById(`test_${category}_${skillIndex}`);
        const reponses = {};

        // Chercher tous les inputs radio cochés dans ce test
        const radioInputs = testContainer.querySelectorAll('input[type="radio"]:checked');
        radioInputs.forEach(radio => {
            reponses[radio.name] = radio.value;
        });

        // Chercher aussi les textarea si présents
        const textareas = testContainer.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            reponses[textarea.id] = textarea.value;
        });

        console.log('Réponses collectées:', reponses);

        fetch(`/submit-test/${category}/${skillIndex}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reponses: reponses })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayResult(category, skillIndex, data.evaluation);
                button.innerHTML = '<i class="fas fa-check-double me-1"></i>Évalué';
            } else {
                throw new Error(data.error || 'Erreur lors de l\'évaluation');
            }
        })
        .catch(error => {
            button.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Erreur';
            alert('Erreur: ' + error.message);
            button.disabled = false;
        });
    }

    function displayResult(category, skillIndex, evaluation) {
        const resultContainer = document.getElementById(`result_${category}_${skillIndex}`);
        const niveauContainer = document.getElementById(`niveau_reel_${category}_${skillIndex}`);

        let statusClass = '';
        let statusIcon = '';

        switch(evaluation.statut) {
            case 'excellent':
                statusClass = 'success';
                statusIcon = 'fas fa-trophy';
                break;
            case 'reussi':
                statusClass = 'info';
                statusIcon = 'fas fa-thumbs-up';
                break;
            case 'echec':
                statusClass = 'danger';
                statusIcon = 'fas fa-times-circle';
                break;
        }

        // Mettre à jour le badge de niveau à côté du nom de la compétence
        const niveauBadgeContainer = document.getElementById(`niveau_badge_${category}_${skillIndex}`);
        const statusContainer = document.getElementById(`status_${category}_${skillIndex}`);

        if (evaluation.niveau_reel) {
            let niveauBadgeClass = 'success';
            if (evaluation.pourcentage >= 90) niveauBadgeClass = 'success';
            else if (evaluation.pourcentage >= 75) niveauBadgeClass = 'info';
            else if (evaluation.pourcentage >= 60) niveauBadgeClass = 'warning';
            else niveauBadgeClass = 'danger';

            // Mettre à jour le badge à côté du nom avec la difficulté
            if (niveauBadgeContainer) {
                let difficulte = evaluation.niveau_difficulte || 'moyen';
                niveauBadgeContainer.innerHTML = `
                    <span class="badge bg-${niveauBadgeClass} ms-2">${evaluation.niveau_reel.toUpperCase()}</span>
                    <span class="badge bg-info ms-1" style="font-size: 0.7em;">${difficulte}</span>
                `;
            }

            // Mettre à jour le statut
            if (statusContainer) {
                statusContainer.innerHTML = `
                    <small class="text-success"><i class="fas fa-check-circle me-1"></i>${evaluation.pourcentage}%</small>
                `;
            }
        }

        let html = `
            <div class="card border-${statusClass}">
                <div class="card-header bg-${statusClass} text-white">
                    <h6 class="mb-0">
                        <i class="${statusIcon} me-2"></i>
                        Résultat: ${evaluation.statut.toUpperCase()} - ${evaluation.pourcentage}%
                        <span class="badge bg-light text-dark ms-2">Niveau: ${evaluation.niveau_reel.toUpperCase()}</span>
                    </h6>
                </div>
                <div class="card-body">
                    <p class="lead">${evaluation.message}</p>
                    <p><strong>Score:</strong> ${evaluation.score_total} / ${evaluation.max_points} points</p>
                    <p><strong>Compétence testée:</strong> ${evaluation.competence_testee}</p>
                    <p><strong>Niveau évalué:</strong> <span class="badge bg-primary">${evaluation.niveau_reel.toUpperCase()}</span></p>

                    <h6 class="mt-3">Détails des réponses:</h6>
        `;

        evaluation.resultats_detailles.forEach((resultat, i) => {
            const iconClass = resultat.correcte ? 'fas fa-check text-success' : 'fas fa-times text-danger';
            html += `
                <div class="mb-2 p-2 bg-light rounded">
                    <p class="mb-1"><i class="${iconClass} me-2"></i><strong>Q${i+1}:</strong> ${resultat.question}</p>
                    <small>Votre réponse: ${resultat.votre_reponse || 'Non répondu'}</small><br>
                    ${!resultat.correcte ? `<small class="text-muted">Réponse correcte: ${resultat.reponse_correcte}</small><br>` : ''}
                    <small class="text-muted">${resultat.explication}</small>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;

        resultContainer.innerHTML = html;
        resultContainer.style.display = 'block';

        // Scroll vers le résultat
        resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
</script>

<style>
    .skill-item {
        transition: all 0.3s;
    }

    .skill-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .test-container {
        animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    pre code {
        font-size: 0.9rem;
    }
</style>
{% endblock %}
