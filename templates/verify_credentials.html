{% extends "base.html" %}

{% block title %}Vérification Documentaire - JobMatch Pro{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <h2 class="mb-4 text-center">
            <i class="fas fa-file-certificate me-2 text-warning"></i>
            Vérification Documentaire
        </h2>

        <!-- Intro -->
        <div class="alert alert-info mb-4">
            <h5><i class="fas fa-info-circle me-2"></i>Comment ça marche ?</h5>
            <ol class="mb-0">
                <li>Nous avons extrait les certificats et attestations déclarés dans votre CV</li>
                <li>Pour chaque élément, uploadez la preuve correspondante (certificat, diplôme, attestation)</li>
                <li>La vérification automatique démarre immédiatement après l'upload</li>
            </ol>
        </div>

        <!-- Résumé -->
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-clipboard-list me-2"></i>
                    Résumé de votre profil
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>CV :</strong> {{ cv_filename }}</p>
                        <p><strong>Total d'éléments à vérifier :</strong> {{ credentials.total_claims }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Résumé :</strong> {{ credentials.resume }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Diplômes -->
        {% if credentials.diplomes and credentials.diplomes|length > 0 %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-graduation-cap me-2"></i>
                    Diplômes ({{ credentials.diplomes|length }})
                </h5>
            </div>
            <div class="card-body">
                {% for diplome in credentials.diplomes %}
                <div class="credential-item mb-3 p-3 border rounded" id="diplomes_{{ loop.index0 }}">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-1">{{ diplome.nom }}</h6>
                            <p class="mb-1"><i class="fas fa-university me-1 text-muted"></i> {{ diplome.organisme }}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i> {{ diplome.date }}
                                {% if diplome.niveau %} | <i class="fas fa-level-up-alt me-1"></i> {{ diplome.niveau }}{% endif %}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <label for="proof_diplomes_{{ loop.index0 }}" class="btn btn-outline-primary btn-sm mb-2 w-100">
                                <i class="fas fa-upload me-1"></i>Uploader la preuve
                            </label>
                            <input type="file"
                                   class="d-none"
                                   id="proof_diplomes_{{ loop.index0 }}"
                                   accept=".pdf,.jpg,.jpeg,.png"
                                   onchange="uploadAndVerify('diplomes', {{ loop.index0 }})">
                            <div class="verification-status mt-2" id="status_diplomes_{{ loop.index0 }}"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Certifications Professionnelles -->
        {% if credentials.certifications_professionnelles and credentials.certifications_professionnelles|length > 0 %}
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-certificate me-2"></i>
                    Certifications Professionnelles ({{ credentials.certifications_professionnelles|length }})
                </h5>
            </div>
            <div class="card-body">
                {% for cert in credentials.certifications_professionnelles %}
                <div class="credential-item mb-3 p-3 border rounded" id="certifications_professionnelles_{{ loop.index0 }}">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-1">{{ cert.nom }}</h6>
                            <p class="mb-1"><i class="fas fa-building me-1 text-muted"></i> {{ cert.organisme }}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i> {{ cert.date }}
                                {% if cert.domaine %} | <i class="fas fa-tag me-1"></i> {{ cert.domaine }}{% endif %}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <label for="proof_certifications_professionnelles_{{ loop.index0 }}" class="btn btn-outline-success btn-sm mb-2 w-100">
                                <i class="fas fa-upload me-1"></i>Uploader la preuve
                            </label>
                            <input type="file"
                                   class="d-none"
                                   id="proof_certifications_professionnelles_{{ loop.index0 }}"
                                   accept=".pdf,.jpg,.jpeg,.png"
                                   onchange="uploadAndVerify('certifications_professionnelles', {{ loop.index0 }})">
                            <div class="verification-status mt-2" id="status_certifications_professionnelles_{{ loop.index0 }}"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Formations Certifiantes -->
        {% if credentials.formations_certifiantes and credentials.formations_certifiantes|length > 0 %}
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-book-reader me-2"></i>
                    Formations Certifiantes ({{ credentials.formations_certifiantes|length }})
                </h5>
            </div>
            <div class="card-body">
                {% for formation in credentials.formations_certifiantes %}
                <div class="credential-item mb-3 p-3 border rounded" id="formations_certifiantes_{{ loop.index0 }}">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-1">{{ formation.nom }}</h6>
                            <p class="mb-1"><i class="fas fa-school me-1 text-muted"></i> {{ formation.organisme }}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i> {{ formation.date }}
                                {% if formation.duree %} | <i class="fas fa-clock me-1"></i> {{ formation.duree }}{% endif %}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <label for="proof_formations_certifiantes_{{ loop.index0 }}" class="btn btn-outline-info btn-sm mb-2 w-100">
                                <i class="fas fa-upload me-1"></i>Uploader la preuve
                            </label>
                            <input type="file"
                                   class="d-none"
                                   id="proof_formations_certifiantes_{{ loop.index0 }}"
                                   accept=".pdf,.jpg,.jpeg,.png"
                                   onchange="uploadAndVerify('formations_certifiantes', {{ loop.index0 }})">
                            <div class="verification-status mt-2" id="status_formations_certifiantes_{{ loop.index0 }}"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Attestations -->
        {% if credentials.attestations and credentials.attestations|length > 0 %}
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-file-signature me-2"></i>
                    Attestations ({{ credentials.attestations|length }})
                </h5>
            </div>
            <div class="card-body">
                {% for attestation in credentials.attestations %}
                <div class="credential-item mb-3 p-3 border rounded" id="attestations_{{ loop.index0 }}">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-1">{{ attestation.nom }}</h6>
                            <p class="mb-1"><i class="fas fa-building me-1 text-muted"></i> {{ attestation.organisme }}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i> {{ attestation.date }}
                                {% if attestation.type %} | <i class="fas fa-tag me-1"></i> {{ attestation.type }}{% endif %}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <label for="proof_attestations_{{ loop.index0 }}" class="btn btn-outline-secondary btn-sm mb-2 w-100">
                                <i class="fas fa-upload me-1"></i>Uploader la preuve
                            </label>
                            <input type="file"
                                   class="d-none"
                                   id="proof_attestations_{{ loop.index0 }}"
                                   accept=".pdf,.jpg,.jpeg,.png"
                                   onchange="uploadAndVerify('attestations', {{ loop.index0 }})">
                            <div class="verification-status mt-2" id="status_attestations_{{ loop.index0 }}"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Langues Certifiées -->
        {% if credentials.langues_certifiees and credentials.langues_certifiees|length > 0 %}
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="fas fa-language me-2"></i>
                    Certifications Linguistiques ({{ credentials.langues_certifiees|length }})
                </h5>
            </div>
            <div class="card-body">
                {% for langue in credentials.langues_certifiees %}
                <div class="credential-item mb-3 p-3 border rounded" id="langues_certifiees_{{ loop.index0 }}">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-1">{{ langue.certification }} - {{ langue.langue }}</h6>
                            <p class="mb-1"><i class="fas fa-award me-1 text-muted"></i> Niveau : {{ langue.niveau }}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i> {{ langue.date }}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <label for="proof_langues_certifiees_{{ loop.index0 }}" class="btn btn-outline-dark btn-sm mb-2 w-100">
                                <i class="fas fa-upload me-1"></i>Uploader la preuve
                            </label>
                            <input type="file"
                                   class="d-none"
                                   id="proof_langues_certifiees_{{ loop.index0 }}"
                                   accept=".pdf,.jpg,.jpeg,.png"
                                   onchange="uploadAndVerify('langues_certifiees', {{ loop.index0 }})">
                            <div class="verification-status mt-2" id="status_langues_certifiees_{{ loop.index0 }}"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="text-center mt-4">
            <a href="{{ url_for('my_cv') }}" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-arrow-left me-2"></i>
                Retour à Mon CV
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-home me-2"></i>
                Retour à la recherche
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function uploadAndVerify(category, itemIndex) {
        const fileInput = document.getElementById(`proof_${category}_${itemIndex}`);
        const statusDiv = document.getElementById(`status_${category}_${itemIndex}`);
        const file = fileInput.files[0];

        if (!file) {
            return;
        }

        // Afficher "En cours de vérification"
        statusDiv.innerHTML = `
            <div class="alert alert-info mb-0 p-2">
                <small>
                    <i class="fas fa-spinner fa-spin me-1"></i>
                    <strong>Votre dossier en cours de vérification...</strong>
                </small>
            </div>
        `;

        const formData = new FormData();
        formData.append('proof_file', file);

        // Étape 1: Upload du fichier
        fetch(`/upload-proof/${category}/${itemIndex}`, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            // Vérifier le status HTTP
            if (response.status === 413) {
                throw new Error('Fichier trop volumineux (max 50MB)');
            }
            if (!response.ok) {
                throw new Error(`Erreur HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Afficher l'aperçu de l'image/PDF
                statusDiv.innerHTML = `
                    <div class="alert alert-info mb-2 p-2">
                        <small>
                            <i class="fas fa-spinner fa-spin me-1"></i>
                            <strong>Vérification en cours...</strong>
                        </small>
                    </div>
                    <img src="/proof-preview/${category}/${itemIndex}"
                         alt="Aperçu"
                         class="img-thumbnail mt-2"
                         style="max-width: 200px; max-height: 200px;"
                         onerror="this.style.display='none'">
                `;

                // Étape 2: Vérification automatique
                return fetch(`/verify-proof/${category}/${itemIndex}`, {
                    method: 'POST'
                });
            } else {
                throw new Error(data.error || 'Erreur lors de l\'upload');
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur HTTP ${response.status} lors de la vérification`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                displayVerificationResult(statusDiv, data.verification);
            } else {
                throw new Error(data.error || 'Erreur lors de la vérification');
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `
                <div class="alert alert-danger mb-0 p-2">
                    <small>
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Erreur:</strong> ${error.message}
                    </small>
                </div>
            `;
        });
    }

    function displayVerificationResult(statusDiv, verification) {
        console.log('Verification result:', verification);

        // Vérifier si erreur
        if (verification.erreur) {
            statusDiv.innerHTML = `
                <div class="alert alert-danger mb-0 p-2">
                    <small>
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Erreur:</strong> ${verification.erreur}
                    </small>
                </div>
            `;
            return;
        }

        let statusClass = '';
        let statusIcon = '';
        let statusText = '';

        // Valeurs par défaut si undefined
        const statut = verification.statut || 'inconnu';
        const score_confiance = verification.score_confiance || 0;
        const commentaire = verification.commentaire || 'Aucun commentaire disponible';
        const recommandation = verification.recommandation || 'non défini';

        switch(statut) {
            case 'confirmé':
                statusClass = 'alert-success';
                statusIcon = 'fas fa-check-circle';
                statusText = '✓ Confirmé';
                break;
            case 'partiellement_confirmé':
                statusClass = 'alert-warning';
                statusIcon = 'fas fa-exclamation-circle';
                statusText = '⚠ Partiellement confirmé';
                break;
            case 'non_confirmé':
                statusClass = 'alert-danger';
                statusIcon = 'fas fa-times-circle';
                statusText = '✗ Non confirmé';
                break;
            case 'insuffisant':
                statusClass = 'alert-secondary';
                statusIcon = 'fas fa-question-circle';
                statusText = '? Preuve insuffisante';
                break;
            default:
                statusClass = 'alert-warning';
                statusIcon = 'fas fa-question-circle';
                statusText = 'Statut inconnu';
        }

        // Extraire category et itemIndex depuis l'ID du statusDiv
        const divId = statusDiv.id; // ex: "status_diplomes_0"
        const parts = divId.replace('status_', '').split('_');
        const itemIndex = parts.pop();
        const category = parts.join('_');

        statusDiv.innerHTML = `
            <img src="/proof-preview/${category}/${itemIndex}"
                 alt="Aperçu"
                 class="img-thumbnail mb-2"
                 style="max-width: 200px; max-height: 200px;"
                 onerror="this.style.display='none'">
            <div class="alert ${statusClass} mb-0 p-2">
                <small>
                    <i class="${statusIcon} me-1"></i><strong>${statusText}</strong>
                    <br>Confiance: ${score_confiance}%
                    <br>${commentaire}
                    <br><strong>Recommandation:</strong> ${recommandation}
                </small>
            </div>
        `;
    }
</script>

<style>
    .credential-item {
        transition: all 0.3s;
    }

    .credential-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .verification-status {
        font-size: 0.85rem;
    }
</style>
{% endblock %}
