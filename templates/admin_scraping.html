<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Job Scraper</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
        }
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab:hover {
            color: #667eea;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .source-config {
            background: #f7fafc;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }
        .source-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .source-title {
            font-size: 1.5em;
            color: #2d3748;
            font-weight: 600;
        }
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #667eea;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2d3748;
            font-weight: 500;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }
        .form-group textarea {
            min-height: 80px;
            font-family: inherit;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin-right: 10px;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #48bb78;
            color: white;
        }
        .btn-success:hover {
            background: #38a169;
        }
        .status-box {
            background: #edf2f7;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #e2e8f0;
        }
        .status-item.running {
            border-left-color: #4299e1;
            background: #ebf8ff;
        }
        .status-item.completed {
            border-left-color: #48bb78;
            background: #f0fff4;
        }
        .status-item.error {
            border-left-color: #f56565;
            background: #fff5f5;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        .help-text {
            font-size: 0.85em;
            color: #718096;
            margin-top: 5px;
        }
        .source-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }
        .btn-scrape {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
        }
        .btn-scrape:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        .btn-scrape:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        .progress-container {
            margin-top: 15px;
            display: none;
        }
        .progress-container.active {
            display: block;
        }
        .progress-bar-outer {
            width: 100%;
            height: 25px;
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85em;
            font-weight: 600;
        }
        .progress-status {
            margin-top: 8px;
            font-size: 0.9em;
            color: #4a5568;
        }
        .progress-status.running {
            color: #4299e1;
        }
        .progress-status.completed {
            color: #48bb78;
        }
        .progress-status.error {
            color: #f56565;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Interface Administrateur</h1>
        <p class="subtitle">Gestion compl√®te du scraping d'offres d'emploi</p>

        <div id="alert-box"></div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('config')">‚öôÔ∏è Configuration</button>
        </div>

        <!-- TAB: Dashboard -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total des offres</div>
                    <div class="stat-number" id="stat-total">{{ stats.total_jobs }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Aujourd'hui</div>
                    <div class="stat-number" id="stat-today">{{ stats.jobs_today }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Cette semaine</div>
                    <div class="stat-number" id="stat-week">{{ stats.jobs_this_week }}</div>
                </div>
                {% for source, count in stats.by_source.items() %}
                <div class="stat-card">
                    <div class="stat-label">{{ source }}</div>
                    <div class="stat-number">{{ count }}</div>
                </div>
                {% endfor %}
            </div>

            <button class="btn btn-success" onclick="refreshStats()">üîÑ Actualiser</button>
            <a href="/api/scraping/export/csv" class="btn btn-primary">üìä Exporter CSV</a>
            <a href="/jobs" class="btn btn-primary">üìã Voir toutes les offres</a>
        </div>

        <!-- TAB: Configuration -->
        <div id="config-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è Configuration des Sources</h2>

            <!-- Google Jobs -->
            <div class="source-config">
                <div class="source-header">
                    <div class="source-title">üîç Google Jobs</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="google_jobs_enabled" {% if config.scrapers.google_jobs.enabled %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="form-group">
                    <label>API Key</label>
                    <input type="text" id="google_jobs_api_key" value="{{ config.scrapers.google_jobs.api_key }}" placeholder="Votre cl√© API ScrapingDog">
                    <div class="help-text">Obtenez votre cl√© sur scrapingdog.com</div>
                </div>

                <div class="form-group">
                    <label>Requ√™tes de recherche (une par ligne)</label>
                    <textarea id="google_jobs_queries" placeholder="Tunis informatique&#10;Monastir d√©veloppeur">{{ '\n'.join(config.scrapers.google_jobs.queries) }}</textarea>
                    <div class="help-text">Chaque ligne = une recherche diff√©rente</div>
                </div>

                <div class="form-group">
                    <label>Nombre maximum de r√©sultats par requ√™te</label>
                    <input type="number" id="google_jobs_max_results" value="{{ config.scrapers.google_jobs.max_results }}" min="50" max="500">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Pays (code)</label>
                        <input type="text" id="google_jobs_country" value="{{ config.scrapers.google_jobs.country }}" placeholder="tn">
                    </div>
                    <div class="form-group">
                        <label>Langue (code)</label>
                        <input type="text" id="google_jobs_language" value="{{ config.scrapers.google_jobs.language }}" placeholder="fr">
                    </div>
                </div>

                <div class="source-actions">
                    <button class="btn btn-success" onclick="saveSourceConfig('google_jobs')">
                        üíæ Sauvegarder
                    </button>
                    <button class="btn-scrape" id="btn-google" onclick="scrapeSourceFromConfig('google_jobs')">
                        üöÄ Lancer le scraping
                    </button>
                </div>

                <div class="progress-container" id="progress-google">
                    <div class="progress-bar-outer">
                        <div class="progress-bar-inner" id="progress-bar-google" style="width: 0%">0%</div>
                    </div>
                    <div class="progress-status" id="progress-status-google">En attente...</div>
                </div>
            </div>

            <!-- LinkedIn -->
            <div class="source-config">
                <div class="source-header">
                    <div class="source-title">üíº LinkedIn</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="linkedin_enabled" {% if config.scrapers.linkedin.enabled %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="form-group">
                    <label>Mots-cl√©s (une par ligne)</label>
                    <textarea id="linkedin_keywords" placeholder="d√©veloppeur python&#10;data analyst">{{ '\n'.join(config.scrapers.linkedin.keywords) }}</textarea>
                </div>

                <div class="form-group">
                    <label>Localisation</label>
                    <input type="text" id="linkedin_location" value="{{ config.scrapers.linkedin.location }}" placeholder="Tunisia">
                </div>

                <div class="form-group">
                    <label>Nombre de pages √† scraper</label>
                    <input type="number" id="linkedin_pages" value="{{ config.scrapers.linkedin.pages }}" min="1" max="10">
                </div>

                <div class="source-actions">
                    <button class="btn btn-success" onclick="saveSourceConfig('linkedin')">
                        üíæ Sauvegarder
                    </button>
                    <button class="btn-scrape" id="btn-linkedin" onclick="scrapeSourceFromConfig('linkedin')">
                        üöÄ Lancer le scraping
                    </button>
                </div>

                <div class="progress-container" id="progress-linkedin">
                    <div class="progress-bar-outer">
                        <div class="progress-bar-inner" id="progress-bar-linkedin" style="width: 0%">0%</div>
                    </div>
                    <div class="progress-status" id="progress-status-linkedin">En attente...</div>
                </div>
            </div>

            <!-- France Travail -->
            <div class="source-config">
                <div class="source-header">
                    <div class="source-title">üá´üá∑ France Travail</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="france_travail_enabled" {% if config.scrapers.france_travail.enabled %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="form-group">
                    <label>Client ID</label>
                    <input type="text" id="france_travail_client_id" value="{{ config.scrapers.france_travail.client_id }}" placeholder="PAR_...">
                </div>

                <div class="form-group">
                    <label>Client Secret</label>
                    <input type="password" id="france_travail_client_secret" value="{{ config.scrapers.france_travail.client_secret }}">
                </div>

                <div class="form-group">
                    <label>Nombre de jours √† scraper</label>
                    <input type="number" id="france_travail_days" value="{{ config.scrapers.france_travail.days }}" min="1" max="30">
                </div>

                <div class="source-actions">
                    <button class="btn btn-success" onclick="saveSourceConfig('france_travail')">
                        üíæ Sauvegarder
                    </button>
                    <button class="btn-scrape" id="btn-france" onclick="scrapeSourceFromConfig('france_travail')">
                        üöÄ Lancer le scraping
                    </button>
                </div>

                <div class="progress-container" id="progress-france">
                    <div class="progress-bar-outer">
                        <div class="progress-bar-inner" id="progress-bar-france" style="width: 0%">0%</div>
                    </div>
                    <div class="progress-status" id="progress-status-france">En attente...</div>
                </div>
            </div>

            <!-- Tunisie Travail -->
            <div class="source-config">
                <div class="source-header">
                    <div class="source-title">üáπüá≥ Tunisie Travail</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="tunisie_travail_enabled" {% if config.scrapers.tunisie_travail.enabled %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="form-group">
                    <label>Ville</label>
                    <input type="text" id="tunisie_travail_ville" value="{{ config.scrapers.tunisie_travail.ville }}" placeholder="tunis">
                </div>

                <div class="form-group">
                    <label>Secteur</label>
                    <input type="text" id="tunisie_travail_secteur" value="{{ config.scrapers.tunisie_travail.secteur }}" placeholder="informatique">
                </div>

                <div class="form-group">
                    <label>Nombre de pages</label>
                    <input type="number" id="tunisie_travail_max_pages" value="{{ config.scrapers.tunisie_travail.max_pages }}" min="1" max="10">
                </div>

                <div class="source-actions">
                    <button class="btn btn-success" onclick="saveSourceConfig('tunisie_travail')">
                        üíæ Sauvegarder
                    </button>
                    <button class="btn-scrape" id="btn-tunisie" onclick="scrapeSourceFromConfig('tunisie_travail')">
                        üöÄ Lancer le scraping
                    </button>
                </div>

                <div class="progress-container" id="progress-tunisie">
                    <div class="progress-bar-outer">
                        <div class="progress-bar-inner" id="progress-bar-tunisie" style="width: 0%">0%</div>
                    </div>
                    <div class="progress-status" id="progress-status-tunisie">En attente...</div>
                </div>
            </div>


            <!-- Bouton global pour lancer tous les scrapers -->
            <div style="margin-top: 40px; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; text-align: center;">
                <h2 style="color: white; margin-bottom: 15px;">üöÄ Lancement Global</h2>
                <p style="color: rgba(255,255,255,0.9); margin-bottom: 25px;">Lancer tous les scrapers activ√©s en une seule fois</p>
                <button class="btn" style="background: white; color: #667eea; font-size: 1.2em; padding: 15px 40px; font-weight: bold;" onclick="scrapeAllEnabled()">
                    üöÄ LANCER TOUS LES SCRAPERS
                </button>
                <div id="global-progress" class="progress-container" style="margin-top: 20px; display: none;">
                    <div class="progress-bar-outer" style="border: 2px solid rgba(255,255,255,0.3);">
                        <div class="progress-bar-inner" id="global-progress-bar" style="width: 0%; background: white; color: #667eea;">0%</div>
                    </div>
                    <div class="progress-status" id="global-progress-status" style="color: white; margin-top: 10px;">En attente...</div>
                </div>
            </div>

            <button class="btn btn-success" onclick="saveConfiguration()" style="margin-top: 20px;">üíæ Sauvegarder la Configuration</button>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        function showAlert(message, type = 'success') {
            const alertBox = document.getElementById('alert-box');
            alertBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertBox.innerHTML = '', 5000);
        }

        function getConfigData() {
            return {
                scrapers: {
                    google_jobs: {
                        enabled: document.getElementById('google_jobs_enabled').checked,
                        api_key: document.getElementById('google_jobs_api_key').value,
                        queries: document.getElementById('google_jobs_queries').value.split('\n').filter(q => q.trim()),
                        max_results: parseInt(document.getElementById('google_jobs_max_results').value),
                        country: document.getElementById('google_jobs_country').value,
                        language: document.getElementById('google_jobs_language').value
                    },
                    linkedin: {
                        enabled: document.getElementById('linkedin_enabled').checked,
                        keywords: document.getElementById('linkedin_keywords').value.split('\n').filter(k => k.trim()),
                        location: document.getElementById('linkedin_location').value,
                        pages: parseInt(document.getElementById('linkedin_pages').value),
                        get_descriptions: false
                    },
                    france_travail: {
                        enabled: document.getElementById('france_travail_enabled').checked,
                        client_id: document.getElementById('france_travail_client_id').value,
                        client_secret: document.getElementById('france_travail_client_secret').value,
                        days: parseInt(document.getElementById('france_travail_days').value)
                    },
                    tunisie_travail: {
                        enabled: document.getElementById('tunisie_travail_enabled').checked,
                        ville: document.getElementById('tunisie_travail_ville').value,
                        secteur: document.getElementById('tunisie_travail_secteur').value,
                        max_pages: parseInt(document.getElementById('tunisie_travail_max_pages').value)
                    }
                }
            };
        }

        function saveConfiguration() {
            const config = getConfigData();

            fetch('/api/scraping/config/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showAlert('‚úÖ Configuration sauvegard√©e avec succ√®s!', 'success');
                } else {
                    showAlert('‚ùå Erreur: ' + data.message, 'error');
                }
            })
            .catch(err => showAlert('‚ùå Erreur r√©seau', 'error'));
        }

        function saveSourceConfig(sourceName) {
            const config = getConfigData();

            fetch('/api/scraping/config/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const sourceLabels = {
                        'google_jobs': 'Google Jobs',
                        'linkedin': 'LinkedIn',
                        'france_travail': 'France Travail',
                        'tunisie_travail': 'Tunisie Travail'
                    };
                    showAlert(`‚úÖ Configuration de ${sourceLabels[sourceName]} sauvegard√©e!`, 'success');
                } else {
                    showAlert('‚ùå Erreur: ' + data.message, 'error');
                }
            })
            .catch(err => showAlert('‚ùå Erreur r√©seau', 'error'));
        }

        function scrapeSource(source) {
            showAlert(`‚è≥ D√©marrage du scraping de ${source}...`, 'success');

            fetch(`/api/scraping/source/${source}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    startStatusPolling();
                } else {
                    showAlert(data.message, 'error');
                }
            })
            .catch(err => showAlert('‚ùå Erreur r√©seau', 'error'));
        }

        function scrapeAll() {
            showAlert('‚è≥ D√©marrage du scraping de toutes les sources...', 'success');

            fetch('/api/scraping/all', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    startStatusPolling();
                } else {
                    showAlert(data.message, 'error');
                }
            })
            .catch(err => showAlert('‚ùå Erreur r√©seau', 'error'));
        }

        function scrapeAllEnabled() {
            const globalProgress = document.getElementById('global-progress');
            const globalProgressBar = document.getElementById('global-progress-bar');
            const globalProgressStatus = document.getElementById('global-progress-status');

            // Afficher la barre de progression
            globalProgress.style.display = 'block';
            globalProgressBar.style.width = '10%';
            globalProgressBar.textContent = '10%';
            globalProgressStatus.textContent = 'Lancement de tous les scrapers activ√©s...';

            // Lancer tous les scrapers
            const config = getConfigData();
            const enabledSources = [];

            if (config.scrapers.google_jobs.enabled) enabledSources.push('google_jobs');
            if (config.scrapers.linkedin.enabled) enabledSources.push('linkedin');
            if (config.scrapers.france_travail.enabled) enabledSources.push('france_travail');
            if (config.scrapers.tunisie_travail.enabled) enabledSources.push('tunisie_travail');

            if (enabledSources.length === 0) {
                showAlert('‚ö†Ô∏è Aucun scraper activ√©! Veuillez activer au moins un scraper.', 'error');
                globalProgress.style.display = 'none';
                return;
            }

            showAlert(`üöÄ Lancement de ${enabledSources.length} scraper(s)...`, 'success');

            // Lancer chaque scraper activ√© s√©quentiellement
            let currentIndex = 0;

            function launchNext() {
                if (currentIndex >= enabledSources.length) {
                    globalProgressBar.style.width = '100%';
                    globalProgressBar.textContent = '100%';
                    globalProgressStatus.textContent = `‚úÖ Tous les scrapers termin√©s! ${enabledSources.length} source(s) trait√©e(s)`;
                    setTimeout(() => {
                        refreshStats();
                        globalProgress.style.display = 'none';
                    }, 5000);
                    return;
                }

                const source = enabledSources[currentIndex];
                const progress = Math.round(((currentIndex + 1) / enabledSources.length) * 100);

                globalProgressBar.style.width = progress + '%';
                globalProgressBar.textContent = progress + '%';
                globalProgressStatus.textContent = `Scraping ${currentIndex + 1}/${enabledSources.length}: ${source}...`;

                fetch(`/api/scraping/source/${source}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log(`‚úÖ ${source} lanc√©`);
                    } else {
                        console.error(`‚ùå ${source}: ${data.message}`);
                    }
                    currentIndex++;
                    // Attendre 2 secondes avant de lancer le suivant
                    setTimeout(launchNext, 2000);
                })
                .catch(err => {
                    console.error(`‚ùå Erreur ${source}:`, err);
                    currentIndex++;
                    setTimeout(launchNext, 2000);
                });
            }

            launchNext();
        }

        let statusInterval = null;

        function startStatusPolling() {
            if (statusInterval) return;

            statusInterval = setInterval(() => {
                fetch('/api/scraping/status')
                .then(res => res.json())
                .then(status => {
                    updateStatusDisplay(status);

                    if (!status.is_running) {
                        clearInterval(statusInterval);
                        statusInterval = null;
                        refreshStats();
                    }
                });
            }, 2000);
        }

        function updateStatusDisplay(status) {
            const sources = {
                'google_jobs': 'google',
                'linkedin': 'linkedin',
                'france_travail': 'france',
                'tunisie_travail': 'tunisie'
            };

            Object.keys(sources).forEach(source => {
                const key = sources[source];
                const item = document.getElementById(`status-${key}`);
                const msg = document.getElementById(`status-${key}-msg`);
                const count = document.getElementById(`status-${key}-count`);

                const sourceStatus = status.sources_status[source];

                item.className = `status-item ${sourceStatus.status}`;
                msg.textContent = sourceStatus.message || 'Pr√™t';
                count.textContent = `${sourceStatus.jobs_found} offres`;
            });
        }

        function refreshStats() {
            fetch('/api/scraping/stats')
            .then(res => res.json())
            .then(stats => {
                document.getElementById('stat-total').textContent = stats.total_jobs;
                document.getElementById('stat-today').textContent = stats.jobs_today;
                document.getElementById('stat-week').textContent = stats.jobs_this_week;
                showAlert('üìä Statistiques actualis√©es', 'success');
            });
        }

        // Fonction pour lancer le scraping depuis la configuration
        function scrapeSourceFromConfig(source) {
            const mapping = {
                'google_jobs': 'google',
                'linkedin': 'linkedin',
                'france_travail': 'france',
                'tunisie_travail': 'tunisie'
            };

            const key = mapping[source];
            const button = document.getElementById(`btn-${key}`);
            const progressContainer = document.getElementById(`progress-${key}`);
            const progressBar = document.getElementById(`progress-bar-${key}`);
            const progressStatus = document.getElementById(`progress-status-${key}`);

            // D√©sactiver le bouton
            button.disabled = true;
            button.textContent = '‚è≥ En cours...';

            // Afficher la barre de progression
            progressContainer.classList.add('active');
            progressBar.style.width = '10%';
            progressBar.textContent = '10%';
            progressStatus.textContent = 'D√©marrage du scraping...';
            progressStatus.className = 'progress-status running';

            // Lancer le scraping
            fetch(`/api/scraping/source/${source}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showAlert(`‚úÖ ${data.message}`, 'success');
                    startProgressTracking(source, key);
                } else {
                    showAlert(`‚ùå ${data.message}`, 'error');
                    button.disabled = false;
                    button.textContent = 'üöÄ Lancer le scraping';
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';
                    progressStatus.textContent = 'Erreur: ' + data.message;
                    progressStatus.className = 'progress-status error';
                }
            })
            .catch(err => {
                showAlert('‚ùå Erreur r√©seau', 'error');
                button.disabled = false;
                button.textContent = 'üöÄ Lancer le scraping';
                progressStatus.textContent = 'Erreur r√©seau';
                progressStatus.className = 'progress-status error';
            });
        }

        // Suivi de la progression pour une source sp√©cifique
        let progressIntervals = {};

        function startProgressTracking(source, key) {
            if (progressIntervals[key]) {
                clearInterval(progressIntervals[key]);
            }

            const button = document.getElementById(`btn-${key}`);
            const progressBar = document.getElementById(`progress-bar-${key}`);
            const progressStatus = document.getElementById(`progress-status-${key}`);

            progressIntervals[key] = setInterval(() => {
                fetch('/api/scraping/status')
                .then(res => res.json())
                .then(status => {
                    const sourceStatus = status.sources_status[source];

                    // Calculer la progression (estimation)
                    let progress = 10;
                    if (sourceStatus.status === 'running') {
                        progress = sourceStatus.progress || 50;
                    } else if (sourceStatus.status === 'completed') {
                        progress = 100;
                    } else if (sourceStatus.status === 'error') {
                        progress = 0;
                    }

                    // Mettre √† jour la barre
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';

                    // Mettre √† jour le message
                    let message = sourceStatus.message || 'En cours...';
                    if (sourceStatus.jobs_found > 0) {
                        message += ` (${sourceStatus.jobs_found} offres trouv√©es)`;
                    }
                    progressStatus.textContent = message;

                    // Mettre √† jour le statut
                    if (sourceStatus.status === 'running') {
                        progressStatus.className = 'progress-status running';
                    } else if (sourceStatus.status === 'completed') {
                        progressStatus.className = 'progress-status completed';
                        button.disabled = false;
                        button.textContent = '‚úÖ Termin√©';
                        clearInterval(progressIntervals[key]);
                        setTimeout(() => {
                            button.textContent = 'üöÄ Lancer le scraping';
                            refreshStats();
                        }, 3000);
                    } else if (sourceStatus.status === 'error') {
                        progressStatus.className = 'progress-status error';
                        button.disabled = false;
                        button.textContent = '‚ùå Erreur';
                        clearInterval(progressIntervals[key]);
                        setTimeout(() => {
                            button.textContent = 'üöÄ Lancer le scraping';
                        }, 3000);
                    }

                    // Arr√™ter si le scraping global est termin√©
                    if (!status.is_running && sourceStatus.status !== 'running') {
                        clearInterval(progressIntervals[key]);
                    }
                })
                .catch(err => {
                    console.error('Erreur lors du suivi:', err);
                });
            }, 2000); // Mise √† jour toutes les 2 secondes
        }
    </script>
</body>
</html>
